---
import Base from "@/layouts/Base.astro";
import { getEntry, getCollection } from "astro:content";

// Import components
import ServicesHero from "@/layouts/components/services/ServicesHero.astro";
import CapabilityCard from "@/layouts/components/platforms/CapabilityCard.astro";
import { markdownify } from "@/lib/utils/textConverter";
import Button from "@/layouts/shortcodes/Button.tsx";
import ImageMod from "@/layouts/components/ImageMod.astro";
import RemotionPlayerWrapper from "@/remotion/RemotionPlayerWrapper";

export async function getStaticPaths() {
  const platforms = await getCollection("platforms");

  return platforms.map((platform) => ({
    params: { slug: platform.id },
    props: { platform },
  }));
}

const { slug } = Astro.params;
const { platform } = Astro.props;

// SSR fallback - fetch platform if not in props
const platformEntry = platform || await getEntry("platforms", slug as string);

if (!platformEntry) {
  return Astro.redirect("/404");
}

const {
  title,
  meta_title,
  description,
  platform_product,
  hero,
  overview,
  capabilities,
  partnership,
  implementation,
  cta,
} = platformEntry.data;
---

<Base
  title={title}
  meta_title={meta_title}
  description={description}
>
  <!-- Hero Section -->
  <ServicesHero
    title={hero.title}
    subtitle={hero.content}
    cta={{
      label: hero.button[0]?.label || "Book a Conversation",
      link: hero.button[0]?.link || "/contact",
      subtext: `Expert ${platform_product} deployment and enablement`
    }}
    image={hero.image}
    imageAlt={title}
    backgroundImage={hero.background_image}
  />

  <!-- Overview Section -->
  <section class="section bg-gray-50">
    <div class="container">
      <div class="row items-center">
        <div class="lg:col-6 mb-8 lg:mb-0">
          <h2
            set:html={markdownify(overview.title)}
            class="mb-4"
            data-aos="fade-up-sm"
          />
          <p
            set:html={markdownify(overview.content)}
            class="text-lg mb-6"
            data-aos="fade-up-sm"
            data-aos-delay="100"
          />
          <ul class="space-y-3" data-aos="fade-up-sm" data-aos-delay="200">
            {overview.points.map((point: string) => (
              <li class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-6 h-6 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center mt-0.5">
                  <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <span set:html={markdownify(point)} />
              </li>
            ))}
          </ul>
        </div>
        <div class="lg:col-6" data-aos="fade-left" data-aos-delay="300">
          {platform_product === "Claude" ? (
            <RemotionPlayerWrapper client:visible />
          ) : overview.image ? (
            <ImageMod
              src={overview.image}
              class="rounded-xl shadow-lg"
              alt={overview.title}
              width={600}
              height={400}
            />
          ) : null}
        </div>
      </div>
    </div>
  </section>

  <!-- Capabilities Section -->
  <section class="section">
    <div class="container">
      <div class="row justify-center">
        <div class="sm:col-10 lg:col-8 text-center mb-12">
          <h2
            set:html={markdownify(capabilities.title)}
            class="mb-4"
            data-aos="fade-up-sm"
          />
          {capabilities.subtitle && (
            <p
              set:html={markdownify(capabilities.subtitle)}
              class="text-lg text-dark/70"
              data-aos="fade-up-sm"
              data-aos-delay="100"
            />
          )}
        </div>
      </div>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" data-aos="fade-up-sm" data-aos-delay="200">
        {capabilities.items.map((item) => (
          <CapabilityCard
            title={item.title}
            badge={item.badge}
            description={item.description}
            benefits={item.benefits}
            use_cases={item.use_cases}
            link={item.link}
          />
        ))}
      </div>
    </div>
  </section>

  <!-- Partnership Section -->
  <section class="section bg-gray-50">
    <div class="container">
      <div class="row justify-center">
        <div class="sm:col-10 lg:col-8 text-center mb-8">
          <h2
            set:html={markdownify(partnership.title)}
            class="mb-4"
            data-aos="fade-up-sm"
          />
          <p
            set:html={markdownify(partnership.content)}
            class="text-lg text-dark/70"
            data-aos="fade-up-sm"
            data-aos-delay="100"
          />
        </div>
      </div>
      <div class="row justify-center">
        <div class="lg:col-10">
          <div class="grid md:grid-cols-2 gap-6" data-aos="fade-up-sm" data-aos-delay="200">
            {partnership.points.map((point) => (
              <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                <h3 class="text-lg font-semibold mb-2" set:html={markdownify(point.title)} />
                <p class="text-dark/70" set:html={markdownify(point.content)} />
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Implementation Section -->
  <section class="section">
    <div class="container">
      <div class="row justify-center">
        <div class="sm:col-10 lg:col-8 text-center mb-12">
          <h2
            set:html={markdownify(implementation.title)}
            class="mb-4"
            data-aos="fade-up-sm"
          />
          {implementation.subtitle && (
            <p
              set:html={markdownify(implementation.subtitle)}
              class="text-lg text-dark/70"
              data-aos="fade-up-sm"
              data-aos-delay="100"
            />
          )}
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6" data-aos="fade-up-sm" data-aos-delay="200">
            {implementation.steps.map((step, index: number) => (
              <div class="text-center">
                <div class="mb-6">
                  <div class="w-16 h-16 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white font-bold text-lg">{index + 1}</span>
                  </div>
                </div>
                <h3 class="text-lg font-semibold mb-3" set:html={markdownify(step.title)} />
                <p class="text-dark/70" set:html={markdownify(step.description)} />
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Final CTA Section -->
  <section class="section pb-0">
    <div class="container">
      <div
        class={`rounded-3xl px-5 pt-7 md:px-12 md:pt-24 ${cta.background_image ? 'relative overflow-hidden min-h-[400px] flex items-center' : 'bg-gradient-to-br from-primary to-secondary'}`}
        data-aos="fade-up-sm"
      >
        {cta.background_image && (
          <>
            <div class="absolute inset-0 -z-10">
              <ImageMod
                src={cta.background_image}
                alt={cta.title}
                width={1200}
                height={400}
                class="w-full h-full object-cover"
              />
              <div class="absolute inset-0 bg-gradient-to-br from-primary/60 via-primary/55 to-secondary/60"></div>
            </div>
          </>
        )}
        <div class="row justify-center w-full">
          <div class="col-12 text-center">
            <h2
              set:html={markdownify(cta.title)}
              class={`mb-3 lg:h1 ${cta.background_image ? 'text-white drop-shadow-lg' : 'text-light'}`}
              data-aos="fade-up-sm"
            />
            <p
              set:html={markdownify(cta.content)}
              class={`mb-6 ${cta.background_image ? 'text-white/95 drop-shadow-md' : 'text-light'}`}
              data-aos="fade-up-sm"
            />
            {cta.button.enable && (
              <div data-aos="zoom-in-sm">
                <Button
                  label={cta.button.label}
                  link={cta.button.link}
                  style="light"
                  className="mb-8"
                />
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>
</Base>
