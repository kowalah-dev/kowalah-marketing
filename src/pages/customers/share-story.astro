---
import Base from "@/layouts/Base.astro";
import TestimonialCollector from "@/components/testimonial/TestimonialCollector";
import { SignedIn, SignedOut } from "@clerk/astro/components";
import { clerkClient } from "@clerk/astro/server";

// Opt out of static generation - need runtime auth data
export const prerender = false;

const title = "Share Your Kowalah Story";
const meta_title = "Share Your Story | Kowalah Customer Testimonials";
const description = "Help us capture your experience with Kowalah. Our AI-guided conversation will help create a testimonial you can review and approve.";

// Get current user data from Clerk (server-side)
let clerkUserData = null;
try {
  const user = await Astro.locals.currentUser();
  if (user) {
    // Fetch organization memberships separately (not included in currentUser())
    let primaryOrg = null;
    try {
      const client = await clerkClient(Astro);
      const orgMemberships = await client.users.getOrganizationMembershipList({ userId: user.id });

      console.log('[Clerk Org Memberships]', orgMemberships.data?.length || 0, 'found');

      if (orgMemberships.data && orgMemberships.data.length > 0) {
        primaryOrg = orgMemberships.data[0].organization;
        console.log('[Clerk Primary Org]', primaryOrg?.name, primaryOrg?.imageUrl);
      }
    } catch (orgError) {
      console.error('[Clerk Org Fetch Error]', orgError);
    }

    clerkUserData = {
      name: user.fullName || user.firstName || '',
      email: user.primaryEmailAddress?.emailAddress || '',
      imageUrl: user.imageUrl || null,
      company: primaryOrg?.name || null,
      companyLogo: primaryOrg?.imageUrl || null,
    };

    console.log('[Clerk User Data]', {
      name: clerkUserData.name,
      email: clerkUserData.email,
      hasImage: !!clerkUserData.imageUrl,
      company: clerkUserData.company,
    });
  }
} catch (e) {
  console.error('[Clerk Error]', e);
}
---

<Base title={title} meta_title={meta_title} description={description}>
  <section class="section relative overflow-hidden min-h-screen">
    <!-- Background gradient -->
    <div class="absolute inset-0 bg-gradient-to-br from-gray-50 via-white to-primary/5 -z-10"></div>

    <div class="container">
      <!-- Show testimonial collector only when signed in -->
      <SignedIn isStatic={true}>
        <div class="max-w-3xl mx-auto">
          <TestimonialCollector client:load clerkUser={clerkUserData} />
        </div>
      </SignedIn>

      <!-- Sign-in prompt when not authenticated -->
      <SignedOut isStatic={true}>
        <div class="max-w-2xl mx-auto text-center py-20">
          <div class="mb-8">
            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center mb-6">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-text-dark mb-4">
              Share Your Kowalah Story
            </h1>
            <p class="text-lg text-gray-600 mb-8">
              We'd love to hear about your experience with Kowalah. Our AI-guided conversation will help capture your story in just a few minutes.
            </p>
          </div>

          <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
            <h2 class="text-xl font-semibold text-text-dark mb-4">
              Sign in to continue
            </h2>
            <p class="text-gray-600 mb-6">
              Please sign in with your Kowalah account to share your testimonial.
            </p>
            <a
              href={`${import.meta.env.PUBLIC_CLERK_SIGN_IN_URL || 'https://app.kowalah.com/sign-in'}?redirect_url=${encodeURIComponent(Astro.url.href)}`}
              class="inline-flex items-center justify-center px-6 py-3 rounded-lg bg-gradient-to-r from-primary to-secondary text-white font-medium hover:shadow-lg hover:scale-105 transition-all"
            >
              Sign In to Continue
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
              </svg>
            </a>
          </div>

          <p class="mt-8 text-sm text-gray-500">
            Don't have an account? <a href={`${import.meta.env.PUBLIC_CLERK_SIGN_UP_URL || 'https://app.kowalah.com/sign-up'}?redirect_url=${encodeURIComponent(Astro.url.href)}`} class="text-primary hover:underline">Start your free trial</a>
          </p>
        </div>
      </SignedOut>
    </div>
  </section>
</Base>
