---
import Base from "@/layouts/Base.astro";
import CallToAction from "@/partials/CallToAction.astro";
import FaqAccordion from "@/partials/FaqAccordion.astro";
import PageHeader from "@/partials/PageHeader.astro";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";
import { client, queries } from "@/lib/sanity";

// Get FAQ page header content from Astro content collections
const faqIndex = (await getEntry("faq", "-index")) as CollectionEntry<"faq">;
const { title, content, meta_title, description } = faqIndex.data;

// Fetch FAQ items from Sanity CMS
let faqs: any[] = [];
try {
  faqs = await client.fetch(queries.faqs);
} catch (error) {
  console.error("Failed to fetch FAQs from Sanity:", error);
}

// Extract plain text from Portable Text blocks for JSON-LD
function portableTextToPlain(blocks: any): string {
  if (typeof blocks === "string") return blocks;
  if (!Array.isArray(blocks)) return "";
  return blocks
    .filter((block: any) => block._type === "block")
    .map((block: any) => block.children?.map((child: any) => child.text).join("") || "")
    .join(" ");
}

// Build FAQPage JSON-LD
const faqJsonLd = faqs.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqs.map((faq: any) => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": portableTextToPlain(faq.answer)
    }
  }))
} : null;

const call_to_action = (await getEntry(
  "sections",
  "call-to-action"
)) as CollectionEntry<"sections">;
---

<Base title={title} meta_title={meta_title} description={description}>
  {faqJsonLd && <script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />}
  <PageHeader title={title} content={content} />

  <section class="-mt-20">
    <div class="container">
      <div class="row justify-center">
        <div class="col-12 lg:col-7 mb-14">
          <FaqAccordion faqs={faqs} />
        </div>
      </div>
    </div>
  </section>

  <CallToAction call_to_action={call_to_action} />
</Base>
