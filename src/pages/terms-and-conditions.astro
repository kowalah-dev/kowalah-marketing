---
import Base from "@/layouts/Base.astro";
import PageHeader from "@/partials/PageHeader.astro";
import { client, queries } from "@/lib/sanity";
import RichText from "@/components/portabletext/RichText.astro";
import { markdownify } from "@/lib/utils/textConverter";

// Fetch terms and conditions from Sanity
let legalPage = null;
let errorMessage = null;

try {
  legalPage = await client.fetch(queries.legalPage("terms-and-conditions"));
  
  if (!legalPage) {
    // Fallback: try to find by pageType or title
    legalPage = await client.fetch(`*[_type == "legalPage" && (slug.current == "terms-and-conditions" || title match "Terms*")][0] {
      _id,
      _type,
      title,
      slug,
      pageType,
      effectiveDate,
      lastUpdated,
      content,
      seo {
        title,
        description,
        keywords
      }
    }`);
  }
} catch (error) {
  console.error("Error fetching terms and conditions:", error);
  errorMessage = "Failed to load terms and conditions content";
}

// Fallback metadata if not available from Sanity
const title = legalPage?.seo?.title || legalPage?.title || "Terms and Conditions";
const description = legalPage?.seo?.description || "Kowalah's Terms and Conditions outline the legal agreement between you and Kowalah when using our Digital Chief AI Officer platform and services.";
const lastUpdated = legalPage?.lastUpdated ? new Date(legalPage.lastUpdated).toLocaleDateString('en-GB', { 
  year: 'numeric', 
  month: 'long', 
  day: 'numeric' 
}) : null;
const effectiveDate = legalPage?.effectiveDate ? new Date(legalPage.effectiveDate).toLocaleDateString('en-GB', {
  year: 'numeric',
  month: 'long', 
  day: 'numeric'
}) : null;
---

<Base title={title} meta_title={title} description={description}>
  <PageHeader title={title} content={description} />
  
  <section class="section-sm">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 mx-auto">
          {errorMessage ? (
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-8">
              <p class="font-medium">Error loading terms and conditions</p>
              <p class="text-sm">{errorMessage}</p>
              <p class="text-sm mt-2">Please contact us at <a href="mailto:hello@kowalah.com" class="underline">hello@kowalah.com</a> if you need to review our terms.</p>
            </div>
          ) : legalPage ? (
            <>
              {/* Document metadata */}
              <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-8">
                <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                  {effectiveDate && (
                    <p><strong>Effective Date:</strong> {effectiveDate}</p>
                  )}
                  {lastUpdated && (
                    <p><strong>Last Updated:</strong> {lastUpdated}</p>
                  )}
                  <p><strong>Document Version:</strong> Current</p>
                </div>
              </div>

              {/* Important notice */}
              <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-3">Important Legal Agreement</h3>
                <div class="text-blue-700 dark:text-blue-300 text-sm">
                  <p>These Terms and Conditions constitute a legal agreement between you and Kowalah. By using our Digital Chief AI Officer platform and services, you agree to be bound by these terms. Please read them carefully.</p>
                </div>
              </div>

              {/* Main content */}
              <div class="prose prose-lg max-w-none  prose-headings:text-text-dark prose-p:text-text prose-li:text-text prose-strong:text-text-dark prose-a:text-primary hover:prose-a:text-primary/80">
                {legalPage.content ? (
                  <RichText value={legalPage.content} />
                ) : (
                  <p class="text-gray-500">No content available</p>
                )}
              </div>

              {/* Contact information */}
              <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mt-12">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">Questions About These Terms?</h3>
                <div class="text-gray-700 dark:text-gray-300">
                  <p class="mb-2">If you have any questions about these Terms and Conditions, please contact us:</p>
                  <div class="text-sm space-y-1">
                    <p><strong>Email:</strong> <a href="mailto:hello@kowalah.com" class="underline">hello@kowalah.com</a></p>
                    <p><strong>Company:</strong> Keboko Limited t/as Kowalah</p>
                    <p><strong>Registration:</strong> England and Wales, Company Number 14637359</p>
                  </div>
                </div>
              </div>
            </>
          ) : (
            <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded mb-8">
              <p class="font-medium">Terms and Conditions Temporarily Unavailable</p>
              <p class="text-sm">We're updating our terms and conditions. Please contact us at <a href="mailto:hello@kowalah.com" class="underline">hello@kowalah.com</a> if you have any questions about our terms of service.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>
</Base>